<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Conciliação - TJDFT</title>
    <!-- Carrega o Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Importa a fonte 'Inter' -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Esconde os 'number spinners' em inputs de número */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Container Principal da Aplicação -->
    <div id="app-container" class="p-4 md:p-8 max-w-7xl mx-auto">

        <!-- 1. ESTADO DE CARREGAMENTO -->
        <div id="loading-state" class="flex flex-col items-center justify-center min-h-[80vh]">
            <img src="tjdft-3.png" alt="Logo TJDFT" class="h-12 mx-auto mb-8 animate-pulse"
                 onerror="this.onerror=null; this.src='https://placehold.co/200x50/003366/FFFFFF?text=TJDFT';">
            <p class="text-lg text-gray-700">Carregando plataforma...</p>
        </div>

        <!-- 2. ESTADO DE AUTENTICAÇÃO (Login / Registro) -->
        <div id="auth-state" class="hidden">
            <div class="max-w-md mx-auto bg-white rounded-xl shadow-2xl p-8 mt-10">
                <!-- Logo Audiências -->
                <img src="logocplt.jpg" alt="Logo Audiências Assíncronas" class="w-full rounded-lg mb-8"
                     onerror="this.onerror=null; this.src='https://placehold.co/600x300/f0f0f0/333333?text=Audi%C3%AAncias+Ass%C3%ADncronas';">
                
                <!-- Abas (Tabs) -->
                <div class="mb-6 border-b border-gray-200">
                    <nav class="flex -mb-px">
                        <button id="tab-login" class="w-1/2 py-4 px-1 text-center border-b-2 border-blue-600 font-bold text-blue-600">
                            Entrar
                        </button>
                        <button id="tab-signup" class="w-1/2 py-4 px-1 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            Registrar
                        </button>
                    </nav>
                </div>

                <!-- Formulário de Login -->
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="login-email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                        <input type="password" id="login-password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <p id="login-error" class="text-red-600 text-sm mb-4"></p>
                    <button id="login-button" type="submit" class="w-full bg-blue-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-800 transition duration-300 shadow-lg">
                        Entrar
                    </button>
                </form>

                <!-- Formulário de Registro -->
                <form id="signup-form" class="hidden">
                    <div class="mb-4">
                        <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="signup-email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-2">Senha</Tabel>
                        <input type="password" id="signup-password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="signup-password-confirm" class="block text-sm font-medium text-gray-700 mb-2">Confirmar Senha</Tabel>
                        <input type="password" id="signup-password-confirm" required class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <p id="signup-error" class="text-red-600 text-sm mb-4"></p>
                    <button id="signup-button" type="submit" class="w-full bg-gray-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-800 transition duration-300 shadow-lg">
                        Registrar
                    </button>
                </form>

            </div>
        </div>

        <!-- 3. ESTADO DE PAINEL (Dashboard) -->
        <div id="dashboard-state" class="hidden">
            
            <!-- Cabeçalho do Painel -->
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-300">
                <div class="flex items-center">
                    <img src="tjdft-3.png" alt="Logo TJDFT" class="h-10"
                         onerror="this.onerror=null; this.src='https://placehold.co/150x40/003366/FFFFFF?text=TJDFT';">
                    <h1 class="text-2xl font-bold text-gray-800 ml-4">Minha Plataforma de Conciliação</h1>
                </div>
                <div class="mt-4 md:mt-0">
                    <!-- Info do Usuário (EXIBE EMAIL) -->
                    <div class="text-sm text-gray-600 text-center md:text-right mb-2">
                        Logado como:<br>
                        <strong id="user-email" class="text-gray-900">...</strong>
                    </div>
                    <button id="logout-button" class="w-full md:w-auto bg-red-600 text-white font-medium py-2 px-5 rounded-lg hover:bg-red-700 transition duration-300">
                        Sair
                    </button>
                </div>
            </header>
            
            <!-- NOVO: Painel Administrativo -->
            <div id="admin-panel" class="hidden w-full bg-yellow-50 border border-yellow-300 p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-xl font-bold text-yellow-900 mb-5">Painel do Mediador (Todas as Demandas)</h2>
                <div id="admin-demandas-list" class="space-y-4 max-h-96 overflow-y-auto">
                    <p id="no-admin-demandas-msg" class="text-gray-500">Nenhuma demanda no sistema.</p>
                </div>
            </div>

            <!-- Corpo do Painel (2 Colunas) -->
            <!-- Correção de Layout: 'md:items-start' alinha as colunas no topo -->
            <div class="flex flex-col md:flex-row md:space-x-8 md:items-start">

                <!-- Coluna 1: Minhas Demandas (Recebidas e Iniciadas) -->
                <div class="w-full md:w-1/2 bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-900 mb-5">Minhas Demandas Pessoais</h2>
                    <div id="minhas-demandas-list" class="space-y-4 max-h-96 overflow-y-auto">
                        <!-- Demandas serão inseridas aqui pelo JS -->
                        <p id="no-demandas-msg" class="text-gray-500">Você não possui demandas ativas.</p>
                    </div>
                </div>

                <!-- Coluna 2: Iniciar Nova Demanda (COLAPSÁVEL) -->
                <div class="w-full md:w-1/2 bg-white rounded-xl shadow-lg mt-8 md:mt-0">
                    <!-- Cabeçalho Clicável -->
                    <div id="toggle-new-demanda" class="flex justify-between items-center p-6 cursor-pointer group">
                        <h2 class="text-xl font-bold text-gray-900 group-hover:text-blue-700">Iniciar Nova Demanda</h2>
                        <!-- Ícone de alternância -->
                        <span id="new-demanda-icon" class="text-2xl font-bold text-gray-600 group-hover:text-blue-700">[+]</span>
                    </div>
                    
                    <!-- Conteúdo Colapsável (começa escondido) -->
                    <div id="new-demanda-content" class="px-6 pb-6" style="display: none;">
                        <form id="new-demanda-form" class="space-y-4">
                            <div>
                                <label for="new-demanda-email" class="block text-sm font-medium text-gray-700 mb-2">Email da Outra Parte</label>
                                <input type="email" id="new-demanda-email" required placeholder="email@exemplo.com" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                             <div>
                                <label for="new-demanda-assunto" class="block text-sm font-medium text-gray-700 mb-2">Assunto</label>
                                <input type="text" id="new-demanda-assunto" required placeholder="Ex: Dívida de Aluguel" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="new-demanda-descricao" class="block text-sm font-medium text-gray-700 mb-2">Sua Manifestação Inicial</label>
                                <textarea id="new-demanda-descricao" rows="4" required placeholder="Descreva sua solicitação. Esta será a primeira mensagem da mediação." class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                            <p id="new-demanda-message" class="text-sm"></p>
                            <button id="new-demanda-button" type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition duration-300 shadow-lg">
                                Abrir Demanda
                            </button>
                        </form>
                    </div>
                </div>

            </div>
        </div>

    </div> <!-- Fim #app-container -->

    <!-- NOVO: Modal de Confirmação de Exclusão -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-bold text-gray-900">Confirmar Exclusão</h3>
            <p class="text-sm text-gray-600 mt-2">Você tem certeza que quer apagar esta demanda? Esta ação é irreversível e removerá todo o histórico de chat.</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-delete-btn" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="confirm-delete-btn" class="py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700">Apagar</button>
            </div>
        </div>
    </div>


    <!-- Scripts do Firebase -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Importações do REALTIME DATABASE
        import {
            getDatabase,
            ref,
            set,
            get,
            push,
            onValue,
            query,
            orderByChild,
            equalTo,
            serverTimestamp,
            off, // Para desligar os listeners
            remove // NOVO: Para apagar dados
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";


        // --- INICIALIZAÇÃO E VARIÁVEIS GLOBAIS ---
        
        // Configurações do Firebase fornecidas pelo usuário
        const firebaseConfig = {
            apiKey: "AIzaSyDq-zz_7BLj0VTK0vXS955tBadC4sj9rFg",
            authDomain: "audasync.firebaseapp.com",
            databaseURL: "https://audasync-default-rtdb.firebaseio.com",
            projectId: "audasync",
            storageBucket: "audasync.firebasestorage.app",
            messagingSenderId: "522678342385",
            appId: "1:522678342385:web:1433bd9cc1aaaa14a40f50",
            measurementId: "G-B15ZRTTR5T"
        };

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app); 
        const auth = getAuth(app);
        
        // Define um caminho base fixo para os dados (baseado no projectId)
        const dbBasePath = `artifacts/audasync/public/data`;

        let currentUserId = null;
        let currentUserEmail = null;
        let isUserAdmin = false; // NOVO: Flag de Admin
        
        // Variáveis para os listeners e caches
        let unsubDemandasRecebidas = null;
        let unsubDemandasIniciadas = null;
        let unsubAdminDemandas = null; // NOVO: Listener Admin
        let demandasRecebidasCache = {};
        let demandasIniciadasCache = {};
        let demandaParaApagar = null; // NOVO: Armazena o ID da demanda a ser apagada

        // Referências dos Elementos da UI
        const loadingState = document.getElementById('loading-state');
        const authState = document.getElementById('auth-state');
        const dashboardState = document.getElementById('dashboard-state');

        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const signupForm = document.getElementById('signup-form');
        const signupError = document.getElementById('signup-error');
        
        const tabLogin = document.getElementById('tab-login');
        const tabSignup = document.getElementById('tab-signup');
        
        // ID do display do usuário atualizado
        const userEmailDisplay = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-button');

        const minhasDemandasList = document.getElementById('minhas-demandas-list');
        const noDemandasMsg = document.getElementById('no-demandas-msg');

        // NOVO: Referências do Painel Admin
        const adminPanel = document.getElementById('admin-panel');
        const adminDemandasList = document.getElementById('admin-demandas-list');
        const noAdminDemandasMsg = document.getElementById('no-admin-demandas-msg');

        // NOVO: Referências do Modal
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        const newDemandaForm = document.getElementById('new-demanda-form');
        const newDemandaEmail = document.getElementById('new-demanda-email');
        const newDemandaAssunto = document.getElementById('new-demanda-assunto');
        const newDemandaDescricao = document.getElementById('new-demanda-descricao');
        const newDemandaMessage = document.getElementById('new-demanda-message');
        const newDemandaButton = document.getElementById('new-demanda-button');

        // Referências para o painel colapsável
        const toggleNewDemanda = document.getElementById('toggle-new-demanda');
        const newDemandaContent = document.getElementById('new-demanda-content');
        const newDemandaIcon = document.getElementById('new-demanda-icon');


        // --- CONTROLE DE ESTADO DA UI ---

        function showState(stateName) {
            loadingState.classList.toggle('hidden', stateName !== 'loading');
            authState.classList.toggle('hidden', stateName !== 'auth');
            dashboardState.classList.toggle('hidden', stateName !== 'dashboard');
        }
        
        function showAuthTab(tabName) {
            loginForm.classList.toggle('hidden', tabName !== 'login');
            signupForm.classList.toggle('hidden', tabName !== 'signup');

            tabLogin.classList.toggle('border-blue-600', tabName === 'login');
            tabLogin.classList.toggle('font-bold', tabName === 'login');
            tabLogin.classList.toggle('text-blue-600', tabName === 'login');
            tabLogin.classList.toggle('border-transparent', tabName !== 'login');
            tabLogin.classList.toggle('text-gray-500', tabName !== 'login');

            tabSignup.classList.toggle('border-blue-600', tabName === 'signup');
            tabSignup.classList.toggle('font-bold', tabName === 'signup');
            tabSignup.classList.toggle('text-blue-600', tabName === 'signup');
            tabSignup.classList.toggle('border-transparent', tabName !== 'signup');
            tabSignup.classList.toggle('text-gray-500', tabName !== 'signup');
        }

        function encodeEmailForKey(email) {
            return email.replace(/\./g, '_dot_').replace(/@/g, '_at_').replace(/[\$\#\[\]\/\.]/g, '_');
        }

        // --- AUTENTICAÇÃO ---

        // Mostra o loading state no início
        showState('loading');
        
        // onAuthStateChanged é o principal controlador de estado
        onAuthStateChanged(auth, async (user) => {
            // Limpa listeners antigos ANTES de qualquer outra coisa
            if (unsubDemandasRecebidas) {
                off(unsubDemandasRecebidas.query, 'value', unsubDemandasRecebidas.callback);
                unsubDemandasRecebidas = null;
            }
            if (unsubDemandasIniciadas) {
                off(unsubDemandasIniciadas.query, 'value', unsubDemandasIniciadas.callback);
                unsubDemandasIniciadas = null;
            }
            // NOVO: Limpa listener Admin
            if (unsubAdminDemandas) {
                off(unsubAdminDemandas.query, 'value', unsubAdminDemandas.callback);
                unsubAdminDemandas = null;
            }
            // Limpa os caches
            demandasRecebidasCache = {};
            demandasIniciadasCache = {};
            // NOVO: Reseta flag e painel admin
            isUserAdmin = false;
            adminPanel.classList.add('hidden');
            adminDemandasList.innerHTML = '';


            // Usuário está logado
            if (user) {
                currentUserId = user.uid;
                currentUserEmail = user.email;
                
                // NOVO: Verifica se o usuário é admin
                await checkAdminStatus(user.uid);
                
                // Atualiza o cabeçalho com o EMAIL
                userEmailDisplay.textContent = currentUserEmail;
                
                // Carrega os dados pessoais do usuário (admin ou não)
                loadMinhasDemandas(currentUserId);
                
                // NOVO: Se for admin, mostra painel e carrega todas as demandas
                if (isUserAdmin) {
                    adminPanel.classList.remove('hidden');
                    loadAllDemandasForAdmin();
                    
                    // NOVO: Configura o listener DELEGADO para os botões de apagar no painel admin
                    adminDemandasList.addEventListener('click', (e) => {
                        const deleteButton = e.target.closest('.delete-demanda-btn');
                        if (deleteButton) {
                            e.preventDefault();
                            const id = deleteButton.getAttribute('data-demanda-id');
                            demandaParaApagar = id; // Armazena o ID
                            deleteModal.classList.remove('hidden'); // Mostra o modal
                        }
                    });
                }
                
                showState('dashboard');
            } 
            // Usuário está deslogado
            else {
                currentUserId = null;
                currentUserEmail = null;
                
                if(minhasDemandasList) minhasDemandasList.innerHTML = ''; // Limpa a lista ao deslogar
                if(noDemandasMsg) noDemandasMsg.classList.remove('hidden');
                
                showState('auth');
                showAuthTab('login');
            }
        });

        // Event Listeners das Abas
        tabLogin.addEventListener('click', () => showAuthTab('login'));
        tabSignup.addEventListener('click', () => showAuthTab('signup'));

        // Event Listener de Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loginError.textContent = '';
            showState('loading'); // Mostra loading durante a tentativa

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged vai cuidar de redirecionar
            } catch (error) {
                console.error("Erro de login:", error.code);
                loginError.textContent = getAuthErrorMessage(error.code);
                showState('auth'); // Volta para a tela de auth em caso de erro
                showAuthTab('login');
            }
        });

        // Event Listener de Registro
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirm = document.getElementById('signup-password-confirm').value;
            signupError.textContent = '';

            if (password !== confirm) {
                signupError.textContent = 'As senhas não conferem.';
                return;
            }
            
            showState('loading'); // Mostra loading durante o registro

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Salva o email no diretório de usuários
                const encodedEmail = encodeEmailForKey(user.email);
                const userDirectoryRef = ref(db, `${dbBasePath}/user_directory/${encodedEmail}`);
                await set(userDirectoryRef, { uid: user.uid });
                
                // onAuthStateChanged vai cuidar de redirecionar

            } catch (error) {
                console.error("Erro de registro:", error.code);
                signupError.textContent = getAuthErrorMessage(error.code);
                showState('auth'); // Volta para a tela de auth em caso de erro
                showAuthTab('signup');
            }
        });

        // Event Listener de Logout
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // onAuthStateChanged vai cuidar de redirecionar
            } catch (error) {
                console.error("Erro no logout:", error);
            }
        });

        function getAuthErrorMessage(code) {
            switch (code) {
                case 'auth/invalid-email':
                    return 'Formato de email inválido.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential':
                    return 'Email ou senha incorretos.';
                case 'auth/email-already-in-use':
                    return 'Este email já está em uso.';
                case 'auth/weak-password':
                    return 'A senha deve ter pelo menos 6 caracteres.';
                default:
                    return 'Ocorreu um erro. Tente novamente.';
            }
        }

        // NOVO: Função para verificar status de Admin
        async function checkAdminStatus(uid) {
            // Reseta a flag
            isUserAdmin = false; 
            if (!uid) return;
            
            const adminRef = ref(db, `${dbBasePath}/admins/${uid}`);
            try {
                const snapshot = await get(adminRef);
                isUserAdmin = snapshot.exists(); // Define a flag global
            } catch (error) {
                console.error("Erro ao verificar status de admin:", error);
                isUserAdmin = false;
            }
        }

        // NOVO: Função para apagar uma demanda
        async function deleteDemanda(demandaId) {
            const demandaRef = ref(db, `${dbBasePath}/demandas/${demandaId}`);
            await remove(demandaRef);
            // O listener 'onValue' em 'loadAllDemandasForAdmin'
            // vai automaticamente atualizar a lista.
        }


        // --- LÓGICA DO PAINEL COLAPSÁVEL ---
        // Lógica atualizada para usar style.display
        toggleNewDemanda.addEventListener('click', () => {
            const isHidden = newDemandaContent.style.display === 'none';
            if (isHidden) {
                newDemandaContent.style.display = 'block';
                newDemandaIcon.textContent = '[-]';
            } else {
                newDemandaContent.style.display = 'none';
                newDemandaIcon.textContent = '[+]';
            }
        });

        // --- LÓGICA DO MODAL DE EXCLUSÃO ---
        cancelDeleteBtn.addEventListener('click', () => {
            deleteModal.classList.add('hidden');
            demandaParaApagar = null;
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (demandaParaApagar) {
                confirmDeleteBtn.disabled = true;
                confirmDeleteBtn.textContent = "Apagando...";
                try {
                    await deleteDemanda(demandaParaApagar);
                } catch (error) {
                    console.error("Erro ao apagar demanda:", error);
                } finally {
                    deleteModal.classList.add('hidden');
                    demandaParaApagar = null;
                    confirmDeleteBtn.disabled = false;
                    confirmDeleteBtn.textContent = "Apagar";
                }
            }
        });


        // --- REALTIME DATABASE (Lógica do Painel) ---

        // Carrega demandas ONDE O USUÁRIO É PARTE (Autor ou Réu)
        function loadMinhasDemandas(userId) {
            const demandasRef = ref(db, `${dbBasePath}/demandas`);

            // 1. Listener para Demandas RECEBIDAS (onde sou o réu)
            const qRecebidas = query(demandasRef, orderByChild("reuId"), equalTo(userId));
            const callbackRecebidas = onValue(qRecebidas, (snapshot) => {
                demandasRecebidasCache = snapshot.val() || {};
                renderListaUnificada();
            }, (error) => {
                console.error("Erro ao buscar demandas recebidas:", error);
                if(minhasDemandasList) minhasDemandasList.innerHTML = '<p class="text-red-500">Erro ao carregar demandas. Verifique o índice "reuId" nas Regras do RTDB.</p>';
            });
            unsubDemandasRecebidas = { query: qRecebidas, callback: callbackRecebidas };

            // 2. Listener para Demandas INICIADAS (onde sou o autor)
            const qIniciadas = query(demandasRef, orderByChild("autorId"), equalTo(userId));
            const callbackIniciadas = onValue(qIniciadas, (snapshot) => {
                demandasIniciadasCache = snapshot.val() || {};
                renderListaUnificada();
            }, (error) => {
                console.error("Erro ao buscar demandas iniciadas:", error);
                if(minhasDemandasList) minhasDemandasList.innerHTML = '<p class="text-red-500">Erro ao carregar demandas. Verifique o índice "autorId" nas Regras do RTDB.</p>';
            });
            unsubDemandasIniciadas = { query: qIniciadas, callback: callbackIniciadas };
        }

        // Renderiza a lista de demandas pessoais
        function renderListaUnificada() {
            if(!minhasDemandasList) return; // Proteção caso o elemento não exista
            
            minhasDemandasList.innerHTML = '';
            
            const todasDemandasMap = { ...demandasRecebidasCache, ...demandasIniciadasCache };
            
            const todasDemandasArray = Object.entries(todasDemandasMap).map(([id, data]) => ({
                id: id,
                ...data
            }));

            todasDemandasArray.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

            if (todasDemandasArray.length === 0) {
                noDemandasMsg.classList.remove('hidden');
            } else {
                noDemandasMsg.classList.add('hidden');
                todasDemandasArray.forEach(demanda => {
                    renderDemandaCard(demanda, demanda.id);
                });
            }
        }

        // NOVO: Carrega TODAS as demandas para o Admin
        function loadAllDemandasForAdmin() {
            const demandasRef = ref(db, `${dbBasePath}/demandas`);
            // Ordena por 'createdAt' para pegar as mais recentes
            const qAdmin = query(demandasRef, orderByChild("createdAt")); 
            
            const callbackAdmin = onValue(qAdmin, (snapshot) => {
                if (snapshot.exists()) {
                    noAdminDemandasMsg.classList.add('hidden');
                    adminDemandasList.innerHTML = '';
                    
                    let allDemandas = [];
                    snapshot.forEach((child) => {
                        allDemandas.push({ id: child.key, ...child.val() });
                    });
                    
                    // Reverte o array para mostrar as mais novas primeiro
                    allDemandas.reverse().forEach(demanda => {
                        renderAdminDemandaCard(demanda);
                    });
                    
                } else {
                    noAdminDemandasMsg.classList.remove('hidden');
                    adminDemandasList.innerHTML = '';
                }
            }, (error) => {
                console.error("Erro ao buscar TODAS as demandas (Admin):", error);
                adminDemandasList.innerHTML = '<p class="text-red-500">Erro ao carregar demandas. Verifique o índice "createdAt" nas Regras do RTDB.</p>';
            });
            unsubAdminDemandas = { query: qAdmin, callback: callbackAdmin };
        }

        // NOVO: Renderiza o card para o painel de Admin
        function renderAdminDemandaCard(demanda) {
            const card = document.createElement('div');
            card.className = 'border border-gray-300 bg-white p-3 rounded-lg flex flex-col md:flex-row justify-between md:items-center space-y-2 md:space-y-0';
            
            const chatUrl = `chat.html?id=${demanda.id}`;
            const statusLabel = getStatusLabel(demanda.status);
            const statusClass = getStatusClass(demanda.status);
            let dataFormatada = demanda.createdAt ? new Date(demanda.createdAt).toLocaleString('pt-BR') : '...';

            card.innerHTML = `
                <div class="flex-1">
                    <h4 class="font-bold text-gray-800">${demanda.assunto}</h4>
                    <p class="text-sm text-gray-600">
                        <span class="font-medium">Autor:</span> ${demanda.autorEmail}
                    </p>
                    <p class="text-sm text-gray-600">
                        <span class="font-medium">Réu:</span> ${demanda.reuEmail}
                    </p>
                    <div class="flex items-center space-x-4 mt-1">
                        <p class="text-sm">Status: <span class="font-medium ${statusClass}">${statusLabel}</span></p>
                        <p class="text-xs text-gray-400">Criada em: ${dataFormatada}</p>
                    </div>
                </div>
                <!-- NOVO: Wrapper para os botões -->
                <div class="flex flex-col md:flex-row md:items-center md:space-x-2 space-y-2 md:space-y-0 w-full md:w-auto">
                    <a href="${chatUrl}" class="w-full md:w-auto text-center bg-gray-700 text-white text-sm font-medium py-2 px-4 rounded-lg hover:bg-gray-800 transition duration-300">
                        Gerenciar Chat
                    </a>
                    <!-- NOVO: Botão de Apagar com data-demanda-id -->
                    <button data-demanda-id="${demanda.id}" class="delete-demanda-btn w-full md:w-auto text-center bg-red-600 text-white text-sm font-medium py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">
                        Apagar
                    </button>
                </div>
            `;
            adminDemandasList.appendChild(card);
            // Nenhum listener de clique é anexado aqui; usamos delegação de eventos
        }


        // Retorna o rótulo de status amigável
        function getStatusLabel(status) {
            const labels = {
                "Pendente_Admin_Autor": "Aguardando mediação",
                "Aguardando_Reu": "Aguardando outra parte",
                "Pendente_Admin_Reu": "Aguardando mediação",
                "Aguardando_Autor": "Aguardando sua resposta",
                "Finalizada_Acordo": "Finalizada (Acordo)",
                "Finalizada_Sem_Acordo": "Finalizada (Sem Acordo)"
            };
            return labels[status] || status;
        }

        // Retorna a classe de cor para o status
        function getStatusClass(status) {
            const classes = {
                "Pendente_Admin_Autor": "text-yellow-600",
                "Aguardando_Reu": "text-blue-600",
                "Pendente_Admin_Reu": "text-yellow-600",
                "Aguardando_Autor": "text-green-600", // Destaca que é sua vez
                "Finalizada_Acordo": "text-gray-700",
                "Finalizada_Sem_Acordo": "text-gray-700"
            };
            return classes[status] || 'text-gray-500';
        }

        function renderDemandaCard(demanda, demandaId) {
            const card = document.createElement('div');
            card.className = 'border border-gray-200 p-4 rounded-lg shadow-sm';
            
            const chatUrl = `chat.html?id=${demandaId}`; 
            const isAutor = (demanda.autorId === currentUserId);
            const papelLabel = isAutor ? 'Iniciada por mim' : 'Recebida';
            const papelClasse = isAutor ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800';
            const outraParteLabel = isAutor ? 'Contra:' : 'De:';
            const outraParteEmail = isAutor ? demanda.reuEmail : demanda.autorEmail;

            let dataFormatada = 'Data não disponível';
            if (demanda.createdAt) {
                dataFormatada = new Date(demanda.createdAt).toLocaleString('pt-BR');
            }
            
            // Ajusta o status "Aguardando_Autor" para ser "Sua vez" se eu for o autor
            let statusLabel = getStatusLabel(demanda.status);
            if (demanda.status === 'Aguardando_Autor' && !isAutor) {
                statusLabel = "Aguardando outra parte"; // Se eu sou o réu, ainda estou aguardando o autor
            }
            if (demanda.status === 'Aguardando_Reu' && isAutor) {
                statusLabel = "Aguardando outra parte"; // Se eu sou o autor, estou aguardando o réu
            }
            if (demanda.status === 'Aguardando_Reu' && !isAutor) {
                statusLabel = "Aguardando sua resposta"; // Se eu sou o réu, é minha vez
            }

            let statusClass = getStatusClass(demanda.status);
             if (demanda.status === 'Aguardando_Autor' && !isAutor) {
                statusClass = "text-blue-600";
            }
             if (demanda.status === 'Aguardando_Reu' && isAutor) {
                statusClass = "text-blue-600";
            }
            if (demanda.status === 'Aguardando_Reu' && !isAutor) {
                statusClass = "text-green-600";
            }


            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-bold text-lg text-gray-800">${demanda.assunto}</h3>
                        <p class="text-sm text-gray-600">${outraParteLabel} ${outraParteEmail}</p>
                        <p class="text-xs text-gray-400 mt-1">Criada em: ${dataFormatada}</p>
                        
                        <div class="flex items-center space-x-3 mt-2">
                             <p class="text-sm text-gray-500">Status: 
                                <span class="font-medium ${statusClass}">
                                    ${statusLabel}
                                </span>
                            </p>
                            <span class="text-xs font-medium px-2 py-0.5 rounded-full ${papelClasse}">
                                ${papelLabel}
                            </span>
                        </div>
                    </div>
                    <a href="${chatUrl}" class="bg-blue-600 text-white text-sm font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                        Acessar Chat
                    </a>
                </div>
            `;
            minhasDemandasList.appendChild(card);
        }

        // Event Listener de Criar Nova Demanda (ATUALIZADO)
        newDemandaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const emailReu = newDemandaEmail.value;
            const assunto = newDemandaAssunto.value;
            const descricao = newDemandaDescricao.value; // Esta é a "primeira mensagem"

            if (emailReu === currentUserEmail) {
                newDemandaMessage.textContent = 'Você não pode abrir uma demanda contra si mesmo.';
                newDemandaMessage.className = 'text-red-600 text-sm';
                return;
            }

            newDemandaButton.disabled = true;
            newDemandaButton.textContent = 'Abrindo...';
            newDemandaMessage.textContent = '';
            newDemandaMessage.className = 'text-sm';

            try {
                // Passo 1: Encontrar o UID da outra parte (o "réu")
                const encodedEmailReu = encodeEmailForKey(emailReu);
                const userDirectoryRef = ref(db, `${dbBasePath}/user_directory/${encodedEmailReu}`);
                const userSnapshot = await get(userDirectoryRef);

                if (!userSnapshot.exists()) {
                    throw new Error('Usuário (réu) não encontrado com este email.');
                }
                
                const reuId = userSnapshot.val().uid;

                // Passo 2: Criar o documento da demanda
                const demandasRef = ref(db, `${dbBasePath}/demandas`);
                const newDemandaRef = push(demandasRef); // Gera uma nova chave
                const demandaId = newDemandaRef.key; // Pega a chave gerada
                
                const novaDemanda = {
                    autorId: currentUserId,
                    autorEmail: currentUserEmail,
                    reuId: reuId,
                    reuEmail: emailReu,
                    assunto: assunto,
                    descricaoInicial: descricao, // Mantemos a descrição para referência
                    status: "Pendente_Admin_Autor", // NOVO STATUS INICIAL
                    createdAt: serverTimestamp() 
                };

                // Passo 3: Criar a primeira mensagem (com a descrição)
                const primeiraMensagem = {
                    texto: descricao,
                    remetenteId: currentUserId,
                    remetenteEmail: currentUserEmail,
                    remetenteTipo: "parte",
                    status: "pendente", // Começa pendente de aprovação
                    timestamp: serverTimestamp()
                };

                // Passo 4: Salvar a demanda E a primeira mensagem
                await set(newDemandaRef, novaDemanda); // Salva a demanda
                
                const mensagensRef = ref(db, `${dbBasePath}/demandas/${demandaId}/mensagens`);
                await push(mensagensRef, primeiraMensagem); // Salva a primeira mensagem
                
                newDemandaMessage.textContent = 'Demanda aberta com sucesso!';
                newDemandaMessage.className = 'text-green-600 text-sm';
                newDemandaForm.reset();
                
                // Fecha o painel após o sucesso (usando style.display)
                newDemandaContent.style.display = 'none';
                newDemandaIcon.textContent = '[+]';


            } catch (error) {
                console.error("Erro ao criar demanda:", error);
                newDemandaMessage.textContent = error.message || 'Erro ao abrir demanda.';
                newDemandaMessage.className = 'text-red-600 text-sm';
            } finally {
                newDemandaButton.disabled = false;
                newDemandaButton.textContent = 'Abrir Demanda';
            }
        });
        
        // A aplicação agora é iniciada pelo 'onAuthStateChanged'
        // A chamada 'initializeAuth()' foi removida.

    </script>
</body>
</html>

